#include "controlleritem.h"
#include <QPainter>
#include <QStyleOptionGraphicsItem>
#include <QSvgRenderer>
#include <QBuffer>

namespace {

// Xbox-style controller SVG (based on svgrepo.com/show/136425). Battery removed; triggers and bumpers added.
// viewBox 0 0 580 580; originals use fill #000 so we keep fill for SVG, tint via painter composition if needed.
const char controllerSvg[] = R"svg(<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 580.032 580.032" fill="#000000">
<g fill="#000000">
<path d="M305.053,129.229c-3.182,1.512-8.127,3.941-8.616,6.634c0,0,13.482,13.14,12.895,25.251c2.754-3.874,4.412-8.58,4.412-13.685C313.743,140.08,310.316,133.586,305.053,129.229z"/>
<path d="M142.139,183.213c-14.957,0-27.124,12.167-27.124,27.124c0,14.957,12.167,27.124,27.124,27.124c14.958,0,27.124-12.167,27.124-27.124C169.263,195.38,157.096,183.213,142.139,183.213z"/>
<path d="M365.299,256.941c-23.685,0-42.957,19.266-42.957,42.957s19.272,42.962,42.957,42.962c23.684,0,42.956-19.271,42.956-42.962S388.982,256.941,365.299,256.941z M365.299,333.142c-18.33,0-33.244-14.921-33.244-33.25c0-18.33,14.914-33.244,33.244-33.244c18.329,0,33.243,14.915,33.243,33.244C398.542,318.221,383.628,333.142,365.299,333.142z"/>
<circle cx="479.106" cy="211.323" r="18.77"/>
<circle cx="438.047" cy="251.421" r="18.77"/>
<path d="M505.765,150.961c-16.255-10.392-4.528-16.328-21.353-29.192s-85.104-34.639-96.983-24.743s-25.233,11.873-25.233,11.873h-72.112h-0.122h-72.118c0,0-13.36-1.977-25.233-11.873c-11.873-9.896-80.16,11.873-96.983,24.743c-16.824,12.864-5.098,18.801-21.353,29.192C58.02,161.353,15.467,304.843,15.467,304.843s-55.417,159.823,43.544,179.12c0,0,24.241-15.337,45.025-40.08c8.084-9.627,19.18-20.814,30.985-30.931v-2.638c0-20.569,16.738-37.308,37.308-37.308h233.974c18.513,0,33.923,13.556,36.817,31.261c8.728,4.063,15.129,12.362,16.549,22.143c6.126,6.01,11.732,11.995,16.328,17.479c20.783,24.743,45.024,40.08,45.024,40.08c98.961-19.297,43.544-179.12,43.544-179.12S522.02,161.347,505.765,150.961z M438.047,148.335c13.728,0,24.89,11.169,24.89,24.89c0,13.721-11.162,24.89-24.89,24.89s-24.89-11.163-24.89-24.89S424.319,148.335,438.047,148.335z M399.932,186.433c13.721,0,24.89,11.163,24.89,24.89s-11.162,24.89-24.89,24.89s-24.891-11.169-24.891-24.89S386.204,186.433,399.932,186.433z M332.146,195.398c8.782,0,15.924,7.148,15.924,15.93s-7.142,15.924-15.924,15.924s-15.925-7.142-15.925-15.924S323.364,195.398,332.146,195.398z M142.139,259.414c-27.062,0-49.083-22.02-49.083-49.083c0-27.062,22.02-49.076,49.083-49.076c27.063,0,49.076,22.014,49.076,49.076C191.215,237.394,169.201,259.414,142.139,259.414z M256.399,316.807c0,1.689-1.371,3.061-3.06,3.061h-22.448v22.454c0,1.689-1.371,3.06-3.06,3.06h-24.235c-1.689,0-3.06-1.37-3.06-3.06v-22.454h-22.448c-1.689,0-3.06-1.371-3.06-3.061v-24.235c0-1.688,1.371-3.06,3.06-3.06h22.448v-22.454c0-1.689,1.371-3.06,3.06-3.06h24.235c1.689,0,3.06,1.371,3.06,3.06v22.454h22.448c1.689,0,3.06,1.371,3.06,3.06V316.807z M249.019,227.247c-8.782,0-15.924-7.142-15.924-15.924s7.142-15.931,15.924-15.931s15.924,7.148,15.924,15.931S257.794,227.247,249.019,227.247z M290.022,177.271c-16.457,0-29.841-13.391-29.841-29.841c0-16.45,13.391-29.841,29.841-29.841c16.45,0,29.841,13.391,29.841,29.841C319.863,163.88,306.479,177.271,290.022,177.271z M365.299,348.974c-27.063,0-49.077-22.02-49.077-49.082c0-27.063,22.014-49.077,49.077-49.077c27.062,0,49.076,22.014,49.076,49.077C414.375,326.954,392.361,348.974,365.299,348.974z M438.047,276.311c-13.728,0-24.89-11.169-24.89-24.89s11.162-24.89,24.89-24.89s24.89,11.163,24.89,24.89S451.774,276.311,438.047,276.311z M479.106,236.213c-13.728,0-24.891-11.169-24.891-24.89c0-13.721,11.163-24.89,24.891-24.89c13.721,0,24.89,11.163,24.89,24.89S492.827,236.213,479.106,236.213z"/>
<path d="M289.796,141.854c-12.007,9.272-15.967,17.062-17.283,21.444c4.345,4.786,10.551,7.852,17.509,7.852c6.769,0,12.846-2.882,17.173-7.448C306.008,159.407,302.183,151.42,289.796,141.854z"/>
<path d="M365.299,272.773c-14.958,0-27.124,12.167-27.124,27.124c0,14.957,12.166,27.13,27.124,27.13c14.957,0,27.123-12.167,27.123-27.13C392.416,284.94,380.256,272.773,365.299,272.773z"/>
<circle cx="332.146" cy="211.323" r="9.804"/>
<circle cx="438.047" cy="173.226" r="18.77"/>
<path d="M299.985,125.979c-3.041-1.42-6.395-2.271-9.963-2.271c-3.604,0-6.983,0.869-10.049,2.313c5.392,0.417,8.953,2.705,9.822,3.33C290.689,128.715,294.374,126.316,299.985,125.979z"/>
<path d="M274.827,129.37c-5.171,4.352-8.531,10.79-8.531,18.066c0,4.829,1.469,9.314,3.953,13.06c-0.11-11.934,12.907-24.627,12.907-24.627C282.685,133.256,278.015,130.888,274.827,129.37z"/>
<path d="M142.139,167.381c-23.69,0-42.962,19.266-42.962,42.957s19.272,42.962,42.962,42.962c23.685,0,42.957-19.272,42.957-42.962S165.829,167.381,142.139,167.381z M142.139,243.575c-18.329,0-33.244-14.915-33.244-33.244c0-18.329,14.915-33.244,33.244-33.244c18.33,0,33.244,14.915,33.244,33.244C175.383,228.661,160.474,243.575,142.139,243.575z"/>
<circle cx="249.019" cy="211.323" r="9.804"/>
<circle cx="399.932" cy="211.323" r="18.77"/>
<path d="M224.771,292.571v-22.454h-18.115v22.454c0,1.689-1.371,3.061-3.06,3.061h-22.448v18.115h22.448c1.689,0,3.06,1.371,3.06,3.06v22.454h18.115v-22.454c0-1.688,1.371-3.06,3.06-3.06h22.448v-18.115h-22.448C226.142,295.632,224.771,294.261,224.771,292.571z"/>
</g>
<g fill="#000000" opacity="0.5"><title>Triggers and Bumpers</title>
<rect x="88" y="70" width="65" height="28" rx="6"/>
<rect x="427" y="70" width="65" height="28" rx="6"/>
<rect x="88" y="106" width="65" height="18" rx="4"/>
<rect x="427" y="106" width="65" height="18" rx="4"/>
</g>
</svg>)svg";

} // namespace

QByteArray controllerSvgBytes(const QColor &fillColor)
{
    QByteArray out(controllerSvg);
    if (fillColor.isValid()) {
        QString hex = fillColor.name(QColor::HexRgb);
        out.replace("#000000", hex.toLatin1());
    }
    return out;
}

ControllerItem::ControllerItem(const QRectF &rect, QGraphicsItem *parent)
    : QGraphicsRectItem(rect, parent)
{
    setFlag(QGraphicsItem::ItemIsSelectable);
    m_keyStyle = KeyStyle();
    setPen(m_keyStyle.pen());
    setBrush(Qt::NoBrush);  // transparent background
}

void ControllerItem::setRect(const QRectF &rect)
{
    QGraphicsRectItem::setRect(rect);
}

void ControllerItem::setRect(qreal x, qreal y, qreal w, qreal h)
{
    Q_UNUSED(x);
    Q_UNUSED(y);
    qreal s = qMin(w, h);
    if (s < 20) s = 20;
    QGraphicsRectItem::setRect(0, 0, s, s);
    // Do not recenter here: the layout editor sets pos per handle (bottom/right/corners);
    // overwriting pos would break those resizes.
}

KeyStyle ControllerItem::keyStyle() const
{
    return m_keyStyle;
}

void ControllerItem::setKeyStyle(const KeyStyle &style)
{
    m_keyStyle = style;
    setPen(style.pen());
    setBrush(Qt::NoBrush);
}

void ControllerItem::paint(QPainter *painter, const QStyleOptionGraphicsItem *option, QWidget *widget)
{
    Q_UNUSED(option);
    Q_UNUSED(widget);
    QRectF r = rect();
    if (r.isEmpty())
        return;
    QColor fillColor = m_keyStyle.pen().color();
    if (!fillColor.isValid()) fillColor = Qt::black;
    QSvgRenderer renderer(controllerSvgBytes(fillColor));
    if (!renderer.isValid())
        return;
    painter->save();
    painter->setClipRect(r);
    renderer.render(painter, r);
    painter->restore();
    if (isSelected()) {
        painter->setPen(QPen(Qt::white, 2, Qt::DashLine));
        painter->setBrush(Qt::NoBrush);
        painter->drawRect(r.adjusted(-2, -2, 2, 2));
    }
}
